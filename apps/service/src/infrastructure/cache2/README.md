# cache设计

| key                        | value                                    | 作用                                                           | redis数据结构 | JS内存数据结构 | 缓存时间                                                                                                                                                               |
| -------------------------- | ---------------------------------------- | -------------------------------------------------------------- | ------------- | -------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `表名:索引字段:索引值`     | 业务ID                                   | 通过表索引查询业务ID                                           | string        | String         | 看traffic:表名定，写多短一点，读多长一点，读写数量一样、重置时用默认值 ，redis不可用时用当前节点策略                                                                   |
| `表名:业务ID`              | 内容                                     | 有值情况，通过业务ID查询表内容                                 | hash          | Object         | 看traffic:表名定，写多短一点，读多长一点，读写数量一样、重置时用默认值 ，redis不可用时用当前节点策略                                                                   |
| `表名:业务ID`              | \_\_NULL\_\_                             | 没有值情况，防止越过缓存查库                                   | string        | String         | 看traffic:表名定，写多短一点，读多长一点，读写数量一样、重置时用默认值 ，redis不可用时用当前节点策略                                                                   |
| `表名:D:业务ID`            | \[...表名:索引名:索引值\]                | 通过业务ID查询所有关联的索引                                   | set           | Set            | 看traffic:表名定，写多短一点，读多长一点，读写数量一样、重置时用默认值 ，redis不可用时用当前节点策略                                                                   |
| `缓存版本号:表名:参数hash` | 查找内容                                 | 分页查找                                                       | list          | Array          | 看traffic:表名定，写多短一点，读多长一点，读写数量一样、重置时用默认值 ，redis不可用时用当前节点策略                                                                   |
| `BF:表名`                  | -                                        | 表布隆过滤器                                                   | -             | -              | -                                                                                                                                                                      |
| `traffic:表名:节点标识`    | {读的数量,写的数量,最后时间，缓存版本号} | 判断当前表读多还是写多，控制缓存时间，定时或者达到指定数量重置 | hash          | Object         | redis缓存永久，JS内存只缓存当前节点的数据；redis不可用时，重连后，以节点数量为准；节点不可用时，重连后，以redis为准；计算时所有节点相加，如果redis下线则用当前节点策略 |

| 操作类型 | 关联操作                                                                                                                                    |
| -------- | ------------------------------------------------------------------------------------------------------------------------------------------- |
| 添加单个 | `traffic:表名:节点标识`中`写`+1,修改`缓存版本号`;删除\[`缓存版本号:表名:参数hash`\]                                                         |
| 删除单个 | `traffic:表名:节点标识`中`写`+1,修改`缓存版本号`;删除\[`缓存版本号:表名:参数hash`,`表名:索引字段:索引值` ,`表名:业务ID` ,`表名:D:业务ID` \] |
| 修改单个 | `traffic:表名:节点标识`中`写`+1,修改`缓存版本号`;删除\[`缓存版本号:表名:参数hash`,`表名:索引字段:索引值` ,`表名:业务ID` ,`表名:D:业务ID` \] |
| 查找单个 | `traffic:表名:节点标识`中`读`+1,增加\[`表名:索引字段:索引值` ,`表名:业务ID` ,`表名:D:业务ID` \]                                             |
| 查找多个 | `traffic:表名:节点标识`中`读`+1,增加\[`缓存版本号:表名:参数hash` \]                                                                         |
